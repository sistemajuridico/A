<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M.A | Jus IA Analytics</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { background-color: #020617; color: #f1f5f9; font-family: 'Inter', sans-serif; }
        .glass { background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.05); }
        .btn-premium { background: linear-gradient(135deg, #1d4ed8, #3b82f6); box-shadow: 0 0 20px rgba(59, 130, 246, 0.3); }
        .tab-active { border-bottom: 2px solid #3b82f6; color: white; }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <header class="p-6 border-b border-white/5 flex justify-between items-center glass sticky top-0 z-50">
        <h1 class="text-2xl font-black italic">M.A | <span class="text-blue-500">Analytics</span></h1>
        <div class="flex gap-4">
            <select id="areaDireito" class="bg-slate-900 border border-white/10 p-2 rounded text-xs">
                <option value="Direito Criminal">Criminal</option>
                <option value="Direito Civil">Civil</option>
            </select>
            <button onclick="processar()" id="btnExecutar" class="btn-premium px-6 py-2 rounded font-bold text-xs uppercase tracking-tighter">Iniciar Auditoria</button>
        </div>
    </header>

    <main class="flex-1 p-6 max-w-7xl mx-auto w-full space-y-8">
        
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            <div class="lg:col-span-3 glass rounded-2xl p-6">
                <textarea id="fatosCaso" rows="4" class="w-full bg-transparent text-lg outline-none resize-none" placeholder="Cole o prompt do estrategista local..."></textarea>
            </div>
            <div class="lg:col-span-1 border-2 border-dashed border-slate-700 rounded-2xl p-6 flex flex-col items-center justify-center text-center cursor-pointer hover:border-blue-500 transition-all" onclick="document.getElementById('arquivos').click()">
                <input type="file" id="arquivos" multiple accept=".pdf" class="hidden" onchange="updateLabel()">
                <i class="fa-solid fa-microscope text-3xl text-slate-600 mb-2"></i>
                <p class="text-[10px] uppercase font-bold text-slate-500" id="fileLabel">Anexar PDF</p>
            </div>
        </div>

        <div id="loader" class="hidden text-center py-20">
            <div class="inline-block w-12 h-12 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
            <p class="mt-4 text-blue-500 font-bold animate-pulse">AUDITANDO PROVAS E LAUDOS...</p>
        </div>

        <div id="results" class="hidden space-y-8">
            <div class="flex justify-between items-center">
                <h2 class="text-xl font-bold">Diagnóstico Estratégico</h2>
                <button onclick="baixarDossie()" class="bg-white text-black px-6 py-2 rounded font-bold text-xs hover:bg-blue-600 hover:text-white transition-all">Baixar Dossiê (.docx)</button>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="glass rounded-2xl p-6 border-l-4 border-amber-500">
                    <h3 class="text-xs font-black text-amber-500 uppercase mb-4">Análise de Evidências</h3>
                    <ul id="analiseProvas" class="space-y-3 text-sm text-slate-400"></ul>
                </div>
                <div class="glass rounded-2xl p-6 border-l-4 border-red-600">
                    <h3 class="text-xs font-black text-red-600 uppercase mb-4">Vulnerabilidades</h3>
                    <ul id="vulnerabilidades" class="space-y-3 text-sm text-slate-400"></ul>
                </div>
            </div>

            <div class="glass rounded-2xl p-6">
                <h3 class="text-xs font-black text-green-500 uppercase mb-4">Report p/ Cliente</h3>
                <p id="resumo_cliente" class="text-sm text-slate-300 leading-relaxed"></p>
            </div>

            <div class="glass rounded-2xl overflow-hidden">
                <div class="flex border-b border-white/5">
                    <button onclick="mudarTab('legal')" id="tab-legal" class="flex-1 p-4 text-xs font-bold tab-active">Fundamentação</button>
                    <button onclick="mudarTab('juris')" id="tab-juris" class="flex-1 p-4 text-xs font-bold text-slate-500">Jurisprudência</button>
                </div>
                <div class="p-6">
                    <ul id="listaLegal" class="space-y-3 text-sm text-slate-400"></ul>
                    <ul id="listaJuris" class="hidden space-y-3 text-sm text-slate-400"></ul>
                </div>
            </div>
        </div>
    </main>

    <script>
        let globalData = null;
        function updateLabel() { document.getElementById('fileLabel').innerText = document.getElementById('arquivos').files.length + " PDF(S) CARREGADO(S)"; }
        
        function mudarTab(t) {
            document.getElementById('listaLegal').classList.toggle('hidden', t !== 'legal');
            document.getElementById('listaJuris').classList.toggle('hidden', t !== 'juris');
            document.getElementById('tab-legal').classList.toggle('tab-active', t === 'legal');
            document.getElementById('tab-juris').classList.toggle('tab-active', t === 'juris');
        }

        async function processar() {
            const fatos = document.getElementById('fatosCaso').value;
            if(!fatos) return alert("Cole a análise do estrategista.");
            
            document.getElementById('loader').classList.remove('hidden');
            document.getElementById('results').classList.add('hidden');
            document.getElementById('btnExecutar').disabled = true;

            const fd = new FormData();
            fd.append("fatos_do_caso", fatos);
            fd.append("area_direito", document.getElementById('areaDireito').value);
            for(let f of document.getElementById('arquivos').files) fd.append("arquivos", f);

            try {
                const res = await fetch('/analisar', { method: 'POST', body: fd });
                const { task_id } = await res.json();

                const timer = setInterval(async () => {
                    const sRes = await fetch(`/status/${task_id}`);
                    const sData = await sRes.json();
                    if(sData.status === "done") {
                        clearInterval(timer);
                        render(sData.resultado);
                    } else if(sData.status === "error") {
                        clearInterval(timer);
                        alert("Erro IA: " + sData.erro);
                        document.getElementById('loader').classList.add('hidden');
                        document.getElementById('btnExecutar').disabled = false;
                    }
                }, 4000);
            } catch(e) { 
                alert("Erro de conexão.");
                document.getElementById('loader').classList.add('hidden');
                document.getElementById('btnExecutar').disabled = false;
            }
        }

        function render(d) {
            globalData = d;
            document.getElementById('resumo_cliente').innerText = d.resumo_cliente;
            const fill = (id, arr) => {
                const el = document.getElementById(id); el.innerHTML = '';
                arr.forEach(i => el.innerHTML += `<li class="p-3 bg-white/5 rounded border border-white/5"> ${i}</li>`);
            };
            fill('analiseProvas', d.analise_provas);
            fill('vulnerabilidades', d.vulnerabilidades_contraparte);
            fill('listaLegal', d.base_legal);
            fill('listaJuris', d.jurisprudencia);

            document.getElementById('loader').classList.add('hidden');
            document.getElementById('results').classList.remove('hidden');
            document.getElementById('btnExecutar').disabled = false;
        }

        async function baixarDossie() {
            if(!globalData) return;
            let texto = `DOSSIÊ ANALÍTICO\n\n=== AUDITORIA DE PROVAS ===\n${globalData.analise_provas.join('\n')}\n\n=== VULNERABILIDADES ===\n${globalData.vulnerabilidades_contraparte.join('\n')}`;
            const res = await fetch('/gerar_docx', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ texto_total: texto })
            });
            const b = await res.blob();
            const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = "Analise_MA.docx"; a.click();
        }
    </script>
</body>
</html>
