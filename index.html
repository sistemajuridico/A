<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M.A | Jus IA Experience</title>
    <script src="[https://cdn.tailwindcss.com](https://cdn.tailwindcss.com)"></script>
    <link href="[https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Playfair+Display:wght@700&display=swap](https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Playfair+Display:wght@700&display=swap)" rel="stylesheet">
    <link rel="stylesheet" href="[https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css](https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css)">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'], serif: ['Playfair Display', 'serif'] },
                    colors: { deep: '#020617', panel: '#0f172a', bordercolor: '#1e293b', brand: { 500: '#3b82f6' } }
                }
            }
        }
    </script>
    <style>
        body { background-color: #020617; color: #f1f5f9; overflow-x: hidden; }
        .glass { background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.05); }
        .btn-premium { background: linear-gradient(135deg, #1d4ed8, #3b82f6); box-shadow: 0 0 20px rgba(59, 130, 246, 0.3); }
        .tab-active { border-bottom: 2px solid #3b82f6; color: white; }
        .timeline-item::before { content: ''; position: absolute; left: -17px; top: 5px; width: 12px; height: 12px; border-radius: 50%; background: #3b82f6; border: 2px solid #020617; }
        @media (max-width: 768px) { #sidebar { width: 100%; max-width: 300px; } }
    </style>
</head>
<body class="flex h-screen antialiased">

    <aside id="sidebar" class="hidden md:flex flex-col w-80 border-r border-bordercolor bg-panel h-full z-50 fixed md:relative transition-all">
        <div class="p-8 border-b border-bordercolor text-center flex justify-between items-center md:block">
            <h1 class="font-serif text-3xl font-bold text-white tracking-tighter">M.A</h1>
            <button onclick="toggleMenu()" class="md:hidden text-slate-500 text-2xl"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <div class="p-6 space-y-6 overflow-y-auto">
            <div>
                <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Especialidade Jurídica</label>
                <select id="areaDireito" class="w-full bg-deep border border-bordercolor p-3 rounded-lg text-sm text-white">
                    <option value="Direito Civil, Imobiliário e Consumidor">Civil, Imobiliário e Consumidor</option>
                    <option value="Direito de Família e Sucessões">Família e Sucessões</option>
                    <option value="Direito Penal e Processual Penal">Penal e Processual Penal</option>
                    <option value="Direito Previdenciário">Previdenciário</option>
                    <option value="Direito do Trabalho">Trabalho</option>
                    <option value="Direito Tributário e Empresarial">Tributário e Empresarial</option>
                </select>
            </div>
            <div class="pt-4 border-t border-bordercolor">
                <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Dados do Juízo (Jurimetria)</label>
                <input type="text" id="magistrado" class="w-full bg-deep border border-bordercolor p-3 rounded-lg text-sm text-white mb-2" placeholder="Nome do Juiz/Relator">
                <input type="text" id="tribunal" class="w-full bg-deep border border-bordercolor p-3 rounded-lg text-sm text-white" placeholder="Vara ou Tribunal">
            </div>
            <div class="pt-4 border-t border-bordercolor">
                <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Assinatura Profissional</label>
                <input type="text" id="advNome" class="w-full bg-deep border border-bordercolor p-3 rounded-lg text-sm text-white mb-2" placeholder="Nome do Advogado">
                <input type="text" id="advOAB" class="w-full bg-deep border border-bordercolor p-3 rounded-lg text-sm text-white mb-2" placeholder="OAB/UF">
                <textarea id="advEndereco" class="w-full bg-deep border border-bordercolor p-3 rounded-lg text-sm text-white resize-none" rows="2" placeholder="Endereço/Contato"></textarea>
            </div>
        </div>
    </aside>

    <main class="flex-1 flex flex-col overflow-hidden">
        <div class="md:hidden flex justify-between p-4 bg-panel border-b border-bordercolor">
            <span class="font-bold text-brand-500">M.A | JUS IA</span>
            <button onclick="toggleMenu()" class="text-white"><i class="fa-solid fa-bars"></i></button>
        </div>

        <div class="flex-1 overflow-y-auto p-6 md:p-10">
            <div class="max-w-6xl mx-auto space-y-8">
                
                <header class="mb-10 text-center md:text-left">
                    <h2 class="text-4xl md:text-5xl font-serif font-bold text-white tracking-tighter italic">
                        M.A | <span class="text-brand-500">Jus IA Experience</span>
                    </h2>
                    <p class="text-slate-400 text-lg font-light tracking-wide">
                        Inteligência de Combate, Jurimetria e Estratégia Processual de Elite.
                    </p>
                </header>

                <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
                    <div class="lg:col-span-3 glass rounded-2xl p-6">
                        <textarea id="fatosCaso" rows="8" class="w-full bg-transparent text-lg text-slate-200 outline-none resize-none font-serif" placeholder="Narre o caso, cole instruções ou suba mídias da audiência (áudio/vídeo)..."></textarea>
                    </div>
                    <div class="lg:col-span-1 flex flex-col gap-4">
                        <div class="flex-1 border-2 border-dashed border-slate-700 rounded-2xl p-4 flex flex-col items-center justify-center text-center cursor-pointer hover:border-brand-500 transition-all" onclick="document.getElementById('arquivos').click()">
                            <input type="file" id="arquivos" multiple accept=".pdf,audio/*,video/*" class="hidden" onchange="updateFileLabel()">
                            <i class="fa-solid fa-cloud-arrow-up text-3xl text-slate-600 mb-2"></i>
                            <p class="text-[10px] uppercase font-bold text-slate-500" id="fileLabel">Anexar Autos & Mídia</p>
                        </div>
                        <button id="btnExecutar" onclick="processar()" class="btn-premium p-5 rounded-2xl font-bold text-white shadow-lg disabled:opacity-50">EXECUTAR ANÁLISE TOTAL</button>
                    </div>
                </div>

                <div id="loader" class="hidden text-center py-10">
                    <div class="inline-block w-10 h-10 border-4 border-brand-500 border-t-transparent rounded-full animate-spin"></div>
                    <p class="mt-4 text-brand-500 font-bold animate-pulse">Inteligência Operando em Backstage...</p>
                    <p class="text-[11px] text-slate-400 mt-2" id="loaderMsg">O ficheiro foi recebido com sucesso. A IA está a analisar. Pode demorar alguns minutos.</p>
                </div>

                <div id="results" class="hidden space-y-8 pb-20">
                    <div class="glass rounded-2xl p-6 border border-brand-500/30 flex flex-col md:flex-row justify-between items-center bg-brand-500/5 shadow-lg">
                        <div>
                            <h3 class="font-serif text-xl text-white font-bold">Diagnóstico Finalizado</h3>
                            <p class="text-slate-400 text-sm">Visualize os painéis abaixo ou faça o download da análise estratégica completa.</p>
                        </div>
                        <button onclick="baixarDossieCompleto()" class="mt-4 md:mt-0 btn-premium px-6 py-3 rounded-xl font-bold text-xs text-white shadow-[0_0_15px_rgba(59,130,246,0.5)] flex items-center gap-2 hover:scale-105 transition-transform">
                            <i class="fa-solid fa-file-word text-lg"></i> BAIXAR DOSSIÊ COMPLETO
                        </button>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="glass rounded-2xl p-6">
                            <h3 class="text-xs font-black text-brand-500 uppercase mb-6">Cronologia</h3>
                            <div id="timeline" class="ml-4 border-l border-slate-700 pl-6 space-y-6 relative text-sm"></div>
                        </div>
                        <div class="glass rounded-2xl p-6 border-t-4 border-red-500">
                            <h3 class="text-xs font-black text-red-500 uppercase mb-6">Modo Combate</h3>
                            <ul id="vulnerabilidades" class="space-y-3"></ul>
                        </div>
                        <div class="glass rounded-2xl p-6 border-l-4 border-l-purple-500">
                            <h3 class="text-xs font-black text-purple-500 uppercase mb-6">Jurimetria</h3>
                            <p id="jurimetria" class="text-sm text-slate-300 italic leading-relaxed"></p>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="glass rounded-2xl p-6 border-l-4 border-l-emerald-500">
                            <h3 class="text-xs font-black text-emerald-500 uppercase mb-4">Providências Necessárias</h3>
                            <ul id="checklist" class="space-y-2"></ul>
                        </div>
                        <div class="glass rounded-2xl p-6 border-l-4 border-l-green-500">
                            <div class="flex justify-between items-start mb-4">
                                <h3 class="text-xs font-black text-green-500 uppercase">Report p/ Cliente</h3>
                                <button onclick="copyWA()" class="text-[10px] bg-green-500/20 text-green-400 px-2 py-1 rounded border border-green-500/20 hover:bg-green-500 hover:text-white transition-all">COPIAR</button>
                            </div>
                            <p id="resumo_cliente" class="text-sm text-slate-300 font-sans leading-relaxed"></p>
                        </div>
                    </div>

                    <div class="glass rounded-3xl overflow-hidden border border-white/5 shadow-2xl">
                        <div class="flex border-b border-bordercolor bg-panel/50">
                            <button onclick="mudarTab('legal')" id="tab-legal" class="flex-1 p-4 text-xs font-black uppercase tab-active">Base Legal</button>
                            <button onclick="mudarTab('juris')" id="tab-juris" class="flex-1 p-4 text-xs font-black uppercase text-slate-500">Jurisprudência</button>
                            <button onclick="mudarTab('doutrina')" id="tab-doutrina" class="flex-1 p-4 text-xs font-black uppercase text-slate-500">Doutrina</button>
                        </div>
                        <div class="p-8">
                            <ul id="listaLegal" class="space-y-4"></ul>
                            <ul id="listaJuris" class="hidden space-y-4"></ul>
                            <ul id="listaDoutrina" class="hidden space-y-4"></ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        let analiseGlobal = null; 

        function toggleMenu() { document.getElementById('sidebar').classList.toggle('hidden'); document.getElementById('sidebar').classList.toggle('flex'); }
        function updateFileLabel() { const c = document.getElementById('arquivos').files.length; document.getElementById('fileLabel').innerText = c + " ARQUIVOS PRONTOS"; }

        function mudarTab(tipo) {
            ['legal', 'juris', 'doutrina'].forEach(t => {
                document.getElementById('lista' + t.charAt(0).toUpperCase() + t.slice(1)).classList.add('hidden');
                document.getElementById('tab-' + t).classList.remove('tab-active');
                document.getElementById('tab-' + t).classList.add('text-slate-500');
            });
            document.getElementById('lista' + tipo.charAt(0).toUpperCase() + tipo.slice(1)).classList.remove('hidden');
            document.getElementById('tab-' + tipo).classList.add('tab-active');
            document.getElementById('tab-' + tipo).classList.remove('text-slate-500');
        }

        async function processar() {
            const fatos = document.getElementById('fatosCaso').value;
            if (!fatos || fatos.trim().length < 5) {
                alert("Por favor, descreva os fatos do caso.");
                return;
            }

            const MAX_SIZE = 100 * 1024 * 1024; 
            const arquivosInput = document.getElementById('arquivos').files;
            
            for (let i = 0; i < arquivosInput.length; i++) {
                if (arquivosInput[i].size > MAX_SIZE) {
                    alert(`O ficheiro "${arquivosInput[i].name}" é muito grande. Cada ficheiro deve ter no máximo 100MB.`);
                    return; 
                }
            }

            const btn = document.getElementById('btnExecutar');
            const loader = document.getElementById('loader');
            const results = document.getElementById('results');
            const loaderMsg = document.getElementById('loaderMsg');

            loader.classList.remove('hidden');
            results.classList.add('hidden');
            btn.disabled = true;
            analiseGlobal = null; 
            loaderMsg.innerText = "A enviar ficheiros para o servidor...";

            const fd = new FormData();
            fd.append("fatos_do_caso", fatos);
            fd.append("area_direito", document.getElementById('areaDireito').value || "");
            fd.append("magistrado", document.getElementById('magistrado').value || "");
            fd.append("tribunal", document.getElementById('tribunal').value || "");
            
            for(let f of arquivosInput) fd.append("arquivos", f);

            try {
                const res = await fetch('/analisar', { method: 'POST', body: fd });
                
                if (!res.ok) {
                    if (res.status === 413) {
                        throw new Error("A soma de todos os ficheiros excede o limite do servidor (300MB). Tente enviar menos ficheiros de cada vez.");
                    }
                    try {
                        const errorData = await res.json();
                        throw new Error(errorData.erro || "Erro de servidor.");
                    } catch (errJson) {
                        throw new Error(`Erro no servidor (Status: ${res.status}).`);
                    }
                }

                const contentType = res.headers.get("content-type");
                if (!contentType || !contentType.includes("application/json")) {
                    throw new Error("Erro de conexão na entrega do arquivo.");
                }

                const data = await res.json();
                const taskId = data.task_id;
                
                loaderMsg.innerText = "Ficheiros recebidos! A Inteligência Artificial está a cruzar os dados. Isto não vai travar...";

                const checkInterval = setInterval(async () => {
                    try {
                        const statusRes = await fetch(`/status/${taskId}`);
                        const statusData = await statusRes.json();

                        if (statusData.status === "done") {
                            clearInterval(checkInterval);
                            renderizarResultados(statusData.resultado);
                        } else if (statusData.status === "error") {
                            clearInterval(checkInterval);
                            alert(statusData.erro);
                            loader.classList.add('hidden');
                            btn.disabled = false;
                        }
                    } catch (e) {
                        console.log("A aguardar IA...", e);
                    }
                }, 4000);

            } catch (e) { 
                alert("Falha no processo: " + e.message); 
                loader.classList.add('hidden'); 
                btn.disabled = false;
            }
        }

        function renderizarResultados(d) {
            const loader = document.getElementById('loader');
            const results = document.getElementById('results');
            const btn = document.getElementById('btnExecutar');
            
            analiseGlobal = d; 

            document.getElementById('jurimetria').innerText = d.jurimetria || "Análise indisponível.";
            document.getElementById('resumo_cliente').innerText = d.resumo_cliente || "";

            const tc = document.getElementById('timeline'); tc.innerHTML = '';
            (d.timeline || []).forEach(t => {
                tc.innerHTML += `<div class="timeline-item relative">
                    <span class="text-[10px] font-bold text-brand-500">${t.data}</span>
                    <p class="text-xs text-white">${t.evento}</p>
                </div>`;
            });

            const vc = document.getElementById('vulnerabilidades'); vc.innerHTML = '';
            (d.vulnerabilidades_contraparte || []).forEach(v => {
                vc.innerHTML += `<li class="p-3 bg-red-500/5 border border-red-500/10 rounded-lg text-xs text-slate-400">× ${v}</li>`;
            });

            const cl = document.getElementById('checklist'); cl.innerHTML = '';
            (d.checklist || []).forEach(c => {
                cl.innerHTML += `<li class="flex items-center gap-2 text-xs text-slate-300 p-1"><i class="fa-regular fa-square-check text-emerald-500"></i> ${c}</li>`;
            });

            const carregarL = (lista, id, color) => {
                const el = document.getElementById(id); el.innerHTML = '';
                (lista || []).forEach(item => { el.innerHTML += `<li class="p-4 bg-white/5 rounded-xl border border-white/5 text-xs text-slate-300 border-l-4 border-${color}-500 leading-relaxed">${item}</li>`; });
            };
            carregarL(d.base_legal, 'listaLegal', 'emerald');
            carregarL(d.jurisprudencia, 'listaJuris', 'amber');
            carregarL(d.doutrina, 'listaDoutrina', 'blue');

            loader.classList.add('hidden');
            results.classList.remove('hidden');
            btn.disabled = false;
        }

        function copyWA() { 
            navigator.clipboard.writeText(document.getElementById('resumo_cliente').innerText); 
            alert("Texto copiado!"); 
        }

        async function baixarDossieCompleto() {
            if (!analiseGlobal) return;
            let tc = "M.A | JUS IA EXPERIENCE - DOSSIÊ ESTRATÉGICO COMPLETO\n\n";

            if(analiseGlobal.jurimetria) tc += "=== JURIMETRIA E TENDÊNCIAS DO JUÍZO ===\n" + analiseGlobal.jurimetria + "\n\n";
            if(analiseGlobal.resumo_estrategico) tc += "=== RESUMO TÉCNICO ===\n" + analiseGlobal.resumo_estrategico + "\n\n";
            if(analiseGlobal.resumo_cliente) tc += "=== REPORT AO CLIENTE ===\n" + analiseGlobal.resumo_cliente + "\n\n";
            
            if(analiseGlobal.timeline?.length) {
                tc += "=== CRONOLOGIA DO CASO ===\n";
                analiseGlobal.timeline.forEach(t => tc += `Data: ${t.data} | Evento: ${t.evento}\n`); tc += "\n";
            }
            if(analiseGlobal.vulnerabilidades_contraparte?.length) {
                tc += "=== MODO COMBATE ===\n";
                analiseGlobal.vulnerabilidades_contraparte.forEach(v => tc += `- ${v}\n`); tc += "\n";
            }
            if(analiseGlobal.checklist?.length) {
                tc += "=== PROVIDÊNCIAS NECESSÁRIAS ===\n";
                analiseGlobal.checklist.forEach(c => tc += `- ${c}\n`); tc += "\n";
            }
            if(analiseGlobal.base_legal?.length) {
                tc += "=== BASE LEGAL ===\n";
                analiseGlobal.base_legal.forEach(b => tc += `- ${b}\n`); tc += "\n";
            }
            if(analiseGlobal.jurisprudencia?.length) {
                tc += "=== JURISPRUDÊNCIA APLICÁVEL ===\n";
                analiseGlobal.jurisprudencia.forEach(j => tc += `- ${j}\n`); tc += "\n";
            }
            if(analiseGlobal.doutrina?.length) {
                tc += "=== REFERÊNCIAS DOUTRINÁRIAS ===\n";
                analiseGlobal.doutrina.forEach(d => tc += `- ${d}\n`); tc += "\n";
            }

            enviarParaServidorWord({
                texto_peca: tc,
                advogado_nome: document.getElementById('advNome').value,
                advogado_oab: document.getElementById('advOAB').value,
                advogado_endereco: document.getElementById('advEndereco').value
            }, "MA_Dossie_Estrategico_Completo.docx");
        }

        async function enviarParaServidorWord(payload, nomeArquivo) {
            try {
                const res = await fetch('/gerar_docx', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!res.ok) throw new Error("Erro ao gerar documento.");
                const b = await res.blob();
                const u = window.URL.createObjectURL(b);
                const a = document.createElement('a'); a.href = u; a.download = nomeArquivo; a.click();
            } catch(e) { alert("Erro ao gerar o ficheiro Word."); }
        }
    </script>
</body>
</html>
